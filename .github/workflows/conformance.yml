name: API Conformance Tests

run-name: Run the API Conformance test suite on the changes.

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths:
      - 'llama_stack/**'
      - '!llama_stack/ui/**'
      - 'tests/**'
      - 'uv.lock'
      - 'pyproject.toml'
      - '.github/workflows/conformance.yml' # This workflow
      - '.github/actions/setup-ollama/action.yml'
      - '.github/actions/setup-test-environment/action.yml'
      - '.github/actions/run-and-record-tests/action.yml'
  schedule:
    # If changing the cron schedule, update the provider in the test-matrix job
    - cron: '0 0 * * *'  # (test latest client) Daily at 12 AM UTC
    - cron: '1 0 * * 0'  # (test vllm) Weekly on Sunday at 1 AM UTC

concurrency:
  # Skip concurrency for pushes to main - each commit should be tested independently
  group: ${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && github.run_id || github.ref }}
  cancel-in-progress: true

jobs:
  check-schema-compatibility:
    runs-on: ubuntu-latest
    steps:
      # using 4.1.7 because 5.0.0 fails when trying to run this locally using `act`
      - name: Checkout PR Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Checkout Base Branch
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          path: 'base'

      # does this include yq?
      - name: Install dependencies
        uses: ./.github/actions/setup-runner

      # Install the correct, modern yq tool to handle spec, yq we have by default cannot.
      - name: Install modern yq
        uses: mikefarah/yq@f15500b20a1c991c8729870ba60a4dc3524b6a94 # v4.44.2
        with:
          version: v4.44.2

      - name: Filter Schemas and Run Diff
        run: |
          # Define the filter using the native startswith() syntax
          FILTER_CONDITION='
          .paths |= with_entries(select(
              (.key | startswith("/v1/inference")) or
              (.key | startswith("/v1/vector-io")) or
              (.key | startswith("/v1/vector-dbs")) or
              (.key | startswith("/v1/openai/v1/responses")) or
              (.key | startswith("/v1/openai/chat"))
          ))
          '

          # Use the modern yq to filter the files directly
          yq eval "$FILTER_CONDITION" base/docs/_static/llama-stack-spec.yaml > base-filtered.yaml
          yq eval "$FILTER_CONDITION" docs/_static/llama-stack-spec.yaml > revision-filtered.yaml


      - name: Run OpenAPI Diff on Filtered Schemas
        uses: ./.github/actions/openapi-diff
        with:
          old-spec: 'base-filtered.yaml'
          new-spec: 'revision-filtered.yaml'
