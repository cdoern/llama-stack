name: API Conformance Tests

run-name: Run the API Conformance test suite on the changes.

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths:
      - 'llama_stack/**'
      - '!llama_stack/ui/**'
      - 'tests/**'
      - 'uv.lock'
      - 'pyproject.toml'
      - '.github/workflows/conformance.yml' # This workflow
      - '.github/actions/setup-ollama/action.yml'
      - '.github/actions/setup-test-environment/action.yml'
      - '.github/actions/run-and-record-tests/action.yml'
  schedule:
    # If changing the cron schedule, update the provider in the test-matrix job
    - cron: '0 0 * * *'  # (test latest client) Daily at 12 AM UTC
    - cron: '1 0 * * 0'  # (test vllm) Weekly on Sunday at 1 AM UTC

concurrency:
  # Skip concurrency for pushes to main - each commit should be tested independently
  group: ${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && github.run_id || github.ref }}
  cancel-in-progress: true

jobs:
  check-schema-compatibility:
    runs-on: ubuntu-latest
    steps:
      # using 4.1.7 because 5.0.0 fails when trying to run this locally using `act`
      - name: Checkout PR Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Checkout Base Branch
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          path: 'base'

      # Install the correct, modern yq tool to handle spec, yq we have by default cannot.
      - name: Install modern yq
        run: |
          wget -qO $HOME/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x $HOME/yq
          echo "$HOME" >> $GITHUB_PATH

      - name: Run OpenAPI Diff with Direct Piping
        shell: bash
        run: |
          # Define the filter using the native startswith() syntax
          FILTER_CONDITION=".paths |= with_entries(select(.key | test(\"^/(v1/inference|v1/vector-io|v1/vector-dbs|v1/openai/v1/responses|v1/openai/chat)\")))"

          which yq
          yq --version
          echo "Filter condition: $FILTER_CONDITION"
          
          # Verify source files exist
          echo "=== SOURCE FILES VERIFICATION ==="
          echo "base/docs/_static/llama-stack-spec.yaml exists: $([ -f "base/docs/_static/llama-stack-spec.yaml" ] && echo "YES" || echo "NO")"
          echo "docs/_static/llama-stack-spec.yaml exists: $([ -f "docs/_static/llama-stack-spec.yaml" ] && echo "YES" || echo "NO")"
          
          if [ ! -f "base/docs/_static/llama-stack-spec.yaml" ] || [ ! -f "docs/_static/llama-stack-spec.yaml" ]; then
            echo "ERROR: Required spec files not found"
            exit 1
          fi
          
          # Run openapi-diff with direct piping of yq outputs
          # This eliminates the need to write intermediate JSON files to disk
          echo "Running OpenAPI diff with direct piping..."
          
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            openapitools/openapi-diff:2.0.1 \
            <(yq eval -o=json "$FILTER_CONDITION" base/docs/_static/llama-stack-spec.yaml) \
            <(yq eval -o=json "$FILTER_CONDITION" docs/_static/llama-stack-spec.yaml) \
            --fail-on-incompatible
          
          echo "OpenAPI diff completed successfully"
